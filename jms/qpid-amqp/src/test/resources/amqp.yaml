---
kind: ImageStream
apiVersion: image.openshift.io/v1
metadata:
  name: jboss-amq-63
  annotations:
    openshift.io/display-name: Red Hat JBoss A-MQ 6.3
    openshift.io/provider-display-name: Red Hat, Inc.
    version: 1.4.12
spec:
  tags:
    - name: '1.3'
      annotations:
        description: JBoss A-MQ 6.3 broker image.
        iconClass: icon-amq
        tags: messaging,amq,jboss,hidden
        supports: amq:6.3,messaging
        version: '1.3'
        openshift.io/display-name: Red Hat JBoss A-MQ 6.3
      from:
        kind: DockerImage
        name: registry.access.redhat.com/jboss-amq-6/amq63-openshift:latest
---
kind: Service
apiVersion: v1
spec:
  ports:
    - port: 5672
      targetPort: 5672
  selector:
    deploymentConfig: "work-queue-broker-amq"
metadata:
  name: "work-queue-broker-amq-amqp"
  labels:
    application: "work-queue-broker"
  annotations:
    description: The broker's AMQP port.
---
kind: Service
apiVersion: v1
spec:
  clusterIP: None
  ports:
    - name: mesh
      port: 61616
  selector:
    deploymentConfig: "work-queue-broker-amq"
metadata:
  name: "work-queue-broker-amq-mesh"
  labels:
    application: "work-queue-broker"
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: 'true'
    description: Supports node discovery for mesh formation.
---
kind: DeploymentConfig
apiVersion: apps.openshift.io/v1
metadata:
  name: "work-queue-broker-amq"
  labels:
    application: "work-queue-broker"
spec:
  strategy:
    type: Rolling
    rollingParams:
      maxSurge: 0
  triggers:
    - type: ImageChange
      imageChangeParams:
        automatic: true
        containerNames:
          - "work-queue-broker-amq"
        from:
          kind: ImageStreamTag
          name: jboss-amq-63:1.3
    - type: ConfigChange
  replicas: 1
  selector:
    deploymentConfig: "work-queue-broker-amq"
  template:
    metadata:
      name: "work-queue-broker-amq"
      labels:
        deploymentConfig: "work-queue-broker-amq"
        application: "work-queue-broker"
    spec:
      terminationGracePeriodSeconds: 60
      containers:
        - name: "work-queue-broker-amq"
          image: jboss-amq-63
          imagePullPolicy: Always
          readinessProbe:
            exec:
              command:
              - "/bin/bash"
              - "-c"
              - "/opt/amq/bin/readinessProbe.sh"
          ports:
            - name: amqp
              containerPort: 5672
              protocol: TCP
          env:
            - name: AMQ_USER
              value: "quarkus"
            - name: AMQ_PASSWORD
              value: "quarkus"
            - name: AMQ_TRANSPORTS
              value: "amqp"
            - name: AMQ_QUEUES
              value: "foo/prices,quarkus/foo/prices,prices"
            - name: AMQ_TOPICS
              value: "work-queue/worker-updates"
            - name: MQ_SERIALIZABLE_PACKAGES
              value: ""
            - name: AMQ_MESH_DISCOVERY_TYPE
              value: "dns"
            - name: AMQ_MESH_SERVICE_NAME
              value: "work-queue-broker-amq-mesh"
            - name: AMQ_MESH_SERVICE_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: AMQ_STORAGE_USAGE_LIMIT
              value: "1 gb"
            - name: AMQ_QUEUE_MEMORY_LIMIT
              value: ""
---
apiVersion: "route.openshift.io/v1"
kind: "Route"
metadata:
  labels:
    app.kubernetes.io/name: "work-queue-broker-amq-mesh"
  name: "work-queue-broker-amq-mesh"
spec:
  host: ""
  path: "/"
  port:
    targetPort: 61616
  to:
    kind: "Service"
    name: "work-queue-broker-amq-mesh"
